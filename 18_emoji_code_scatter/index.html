<!doctype html>
<meta charset="utf-8">
<title>Emoji Code Scatter (Rows) â€“ generator</title>

<!-- === size === -->
<label>W <input id=w type=number value=400 min=100></label>
<label>H <input id=h type=number value=600 min=100></label>

<!-- === code + dice === -->
<label>Code <input id=code type=text value=1234 pattern="\d{1,5}" maxlength=5></label>
<button type=button data-t="code">&#x1f3b2;</button>

<hr>

<!-- === visual settings === -->
<label>Number of rows
  <input id=rowCount type=range min=4 max=25 step=1 value=6>
</label><br>

<label>Row height (% H)
  <input id=rowHeight type=range min=4 max=20 step=1 value=12>
</label><br>

<label>Layout mode
  <select id=layoutMode>
    <option value="rows" selected>rows</option>
    <option value="grid">grid</option>
  </select>
</label><br>

<label>Columns
  <select id=columns>
    <option value="auto" selected>auto</option>
    <option value="1">1</option>
    <option value="2">2</option>
  </select>
</label><br>

<label>Grid columns
  <input id=gridCols type=range min=2 max=6 step=1 value=3>
</label><br>

<label><input id=showEmoji type=checkbox> Show emoji in row</label><br>

<label>Marker shape
  <select id=markerShape>
    <option value="circle" selected>circle</option>
    <option value="square">square</option>
    <option value="triangle">triangle</option>
    <option value="star">star</option>
    <option value="diamond">diamond</option>
    <option value="heart">heart</option>
  </select>
</label><br>

<label>Dot style
  <select id=dotStyle>
    <option value="filled" selected>filled</option>
    <option value="outline">outline</option>
    <option value="none">none</option>
  </select>
</label><br>

<label>Leader line style
  <select id=leaderStyle>
    <option value="dots" selected>dots</option>
    <option value="dashes">dashes</option>
    <option value="solid">solid</option>
    <option value="arrows">arrows</option>
    <option value="none">none</option>
  </select>
</label><br>

<label>Number format
  <select id=numberFormat>
    <option value="plain" selected>plain</option>
    <option value="circled">circled</option>
    <option value="boxed">boxed</option>
    <option value="bold-block">bold-block</option>
  </select>
</label><br>

<label>Noise symbol style
  <select id=noiseSymbolStyle>
    <option value="none" selected>none</option>
    <option value="shapes">shapes</option>
    <option value="cards">cards</option>
    <option value="arrows">arrows</option>
  </select>
</label><br>

<label>Category
  <select id=category>
    <option value="all" selected>all</option>
    <option value="animals">animals</option>
    <option value="food">food</option>
    <option value="vehicles">vehicles</option>
    <option value="nature">nature</option>
    <option value="sports">sports</option>
    <option value="objects">objects</option>
  </select>
</label><br>

<label>Language
  <select id=lang>
    <option value="en" selected>EN</option>
    <option value="ru">RU</option>
  </select>
</label><br>

<button id=reset type=button>Restore defaults</button>
<button id=rerender type=button>Re-render</button>

<hr>

<canvas id=can title="Click to download" style="border:1px solid grey;cursor:pointer"></canvas>

<script>
document.querySelectorAll('input[type=range]').forEach(r => {
  const span = document.createElement('span');
  span.style.cssText = 'margin-left:1px;font-size:12px;color:#666';
  span.textContent = r.value;
  r.after(span);
  r.addEventListener('input', () => span.textContent = r.value);
});
</script>

<script>
const EMOJI_LEXICON = [
  { emoji: '\u{1F436}', category: 'animals', names: { en: { singular: 'dog', count: 'dogs' }, ru: { singular: '\u0441\u043E\u0431\u0430\u043A\u0430', count: '\u0441\u043E\u0431\u0430\u043A' } } },
  { emoji: '\u{1F431}', category: 'animals', names: { en: { singular: 'cat', count: 'cats' }, ru: { singular: '\u043A\u043E\u0448\u043A\u0430', count: '\u043A\u043E\u0448\u0435\u043A' } } },
  { emoji: '\u{1F42D}', category: 'animals', names: { en: { singular: 'mouse', count: 'mice' }, ru: { singular: '\u043C\u044B\u0448\u044C', count: '\u043C\u044B\u0448\u0435\u0439' } } },
  { emoji: '\u{1F439}', category: 'animals', names: { en: { singular: 'hamster', count: 'hamsters' }, ru: { singular: '\u0445\u043E\u043C\u044F\u043A', count: '\u0445\u043E\u043C\u044F\u043A\u043E\u0432' } } },
  { emoji: '\u{1F430}', category: 'animals', names: { en: { singular: 'rabbit', count: 'rabbits' }, ru: { singular: '\u043A\u0440\u043E\u043B\u0438\u043A', count: '\u043A\u0440\u043E\u043B\u0438\u043A\u043E\u0432' } } },
  { emoji: '\u{1F98A}', category: 'animals', names: { en: { singular: 'fox', count: 'foxes' }, ru: { singular: '\u043B\u0438\u0441\u0430', count: '\u043B\u0438\u0441' } } },
  { emoji: '\u{1F43B}', category: 'animals', names: { en: { singular: 'bear', count: 'bears' }, ru: { singular: '\u043C\u0435\u0434\u0432\u0435\u0434\u044C', count: '\u043C\u0435\u0434\u0432\u0435\u0434\u0435\u0439' } } },
  { emoji: '\u{1F43C}', category: 'animals', names: { en: { singular: 'panda', count: 'pandas' }, ru: { singular: '\u043F\u0430\u043D\u0434\u0430', count: '\u043F\u0430\u043D\u0434' } } },
  { emoji: '\u{1F42F}', category: 'animals', names: { en: { singular: 'tiger', count: 'tigers' }, ru: { singular: '\u0442\u0438\u0433\u0440', count: '\u0442\u0438\u0433\u0440\u043E\u0432' } } },
  { emoji: '\u{1F981}', category: 'animals', names: { en: { singular: 'lion', count: 'lions' }, ru: { singular: '\u043B\u0435\u0432', count: '\u043B\u044C\u0432\u043E\u0432' } } },
  { emoji: '\u{1F42E}', category: 'animals', names: { en: { singular: 'cow', count: 'cows' }, ru: { singular: '\u043A\u043E\u0440\u043E\u0432\u0430', count: '\u043A\u043E\u0440\u043E\u0432' } } },
  { emoji: '\u{1F438}', category: 'animals', names: { en: { singular: 'frog', count: 'frogs' }, ru: { singular: '\u043B\u044F\u0433\u0443\u0448\u043A\u0430', count: '\u043B\u044F\u0433\u0443\u0448\u0435\u043A' } } },
  { emoji: '\u{1F435}', category: 'animals', names: { en: { singular: 'monkey', count: 'monkeys' }, ru: { singular: '\u043E\u0431\u0435\u0437\u044C\u044F\u043D\u0430', count: '\u043E\u0431\u0435\u0437\u044C\u044F\u043D' } } },
  { emoji: '\u{1F414}', category: 'animals', names: { en: { singular: 'chicken', count: 'chickens' }, ru: { singular: '\u043A\u0443\u0440\u0438\u0446\u0430', count: '\u043A\u0443\u0440\u0438\u0446' } } },
  { emoji: '\u{1F427}', category: 'animals', names: { en: { singular: 'penguin', count: 'penguins' }, ru: { singular: '\u043F\u0438\u043D\u0433\u0432\u0438\u043D', count: '\u043F\u0438\u043D\u0433\u0432\u0438\u043D\u043E\u0432' } } },
  { emoji: '\u{1F986}', category: 'animals', names: { en: { singular: 'duck', count: 'ducks' }, ru: { singular: '\u0443\u0442\u043A\u0430', count: '\u0443\u0442\u043E\u043A' } } },
  { emoji: '\u{1F989}', category: 'animals', names: { en: { singular: 'owl', count: 'owls' }, ru: { singular: '\u0441\u043E\u0432\u0430', count: '\u0441\u043E\u0432' } } },
  { emoji: '\u{1F984}', category: 'animals', names: { en: { singular: 'unicorn', count: 'unicorns' }, ru: { singular: '\u0435\u0434\u0438\u043D\u043E\u0440\u043E\u0433', count: '\u0435\u0434\u0438\u043D\u043E\u0440\u043E\u0433\u043E\u0432' } } },
  { emoji: '\u{1F422}', category: 'animals', names: { en: { singular: 'turtle', count: 'turtles' }, ru: { singular: '\u0447\u0435\u0440\u0435\u043F\u0430\u0445\u0430', count: '\u0447\u0435\u0440\u0435\u043F\u0430\u0445' } } },
  { emoji: '\u{1F419}', category: 'animals', names: { en: { singular: 'octopus', count: 'octopuses' }, ru: { singular: '\u043E\u0441\u044C\u043C\u0438\u043D\u043E\u0433', count: '\u043E\u0441\u044C\u043C\u0438\u043D\u043E\u0433\u043E\u0432' } } },
  { emoji: '\u{1F98B}', category: 'animals', names: { en: { singular: 'butterfly', count: 'butterflies' }, ru: { singular: '\u0431\u0430\u0431\u043E\u0447\u043A\u0430', count: '\u0431\u0430\u0431\u043E\u0447\u0435\u043A' } } },
  { emoji: '\u{1F41D}', category: 'animals', names: { en: { singular: 'bee', count: 'bees' }, ru: { singular: '\u043F\u0447\u0435\u043B\u0430', count: '\u043F\u0447\u0451\u043B' } } },
  { emoji: '\u{1F40C}', category: 'animals', names: { en: { singular: 'snail', count: 'snails' }, ru: { singular: '\u0443\u043B\u0438\u0442\u043A\u0430', count: '\u0443\u043B\u0438\u0442\u043E\u043A' } } },
  { emoji: '\u{1F420}', category: 'animals', names: { en: { singular: 'fish', count: 'fish' }, ru: { singular: '\u0440\u044B\u0431\u0430', count: '\u0440\u044B\u0431' } } },
  { emoji: '\u{1F697}', category: 'vehicles', names: { en: { singular: 'car', count: 'cars' }, ru: { singular: '\u043C\u0430\u0448\u0438\u043D\u0430', count: '\u043C\u0430\u0448\u0438\u043D' } } },
  { emoji: '\u{1F68C}', category: 'vehicles', names: { en: { singular: 'bus', count: 'buses' }, ru: { singular: '\u0430\u0432\u0442\u043E\u0431\u0443\u0441', count: '\u0430\u0432\u0442\u043E\u0431\u0443\u0441\u043E\u0432' } } },
  { emoji: '\u{1F69C}', category: 'vehicles', names: { en: { singular: 'tractor', count: 'tractors' }, ru: { singular: '\u0442\u0440\u0430\u043A\u0442\u043E\u0440', count: '\u0442\u0440\u0430\u043A\u0442\u043E\u0440\u043E\u0432' } } },
  { emoji: '\u{1F6B2}', category: 'vehicles', names: { en: { singular: 'bicycle', count: 'bicycles' }, ru: { singular: '\u0432\u0435\u043B\u043E\u0441\u0438\u043F\u0435\u0434', count: '\u0432\u0435\u043B\u043E\u0441\u0438\u043F\u0435\u0434\u043E\u0432' } } },
  { emoji: '\u{1F686}', category: 'vehicles', names: { en: { singular: 'train', count: 'trains' }, ru: { singular: '\u043F\u043E\u0435\u0437\u0434', count: '\u043F\u043E\u0435\u0437\u0434\u043E\u0432' } } },
  { emoji: '\u{1F681}', category: 'vehicles', names: { en: { singular: 'helicopter', count: 'helicopters' }, ru: { singular: '\u0432\u0435\u0440\u0442\u043E\u043B\u0451\u0442', count: '\u0432\u0435\u0440\u0442\u043E\u043B\u0451\u0442\u043E\u0432' } } },
  { emoji: '\u26F5', category: 'vehicles', names: { en: { singular: 'sailboat', count: 'sailboats' }, ru: { singular: '\u043F\u0430\u0440\u0443\u0441\u043D\u0438\u043A', count: '\u043F\u0430\u0440\u0443\u0441\u043D\u0438\u043A\u043E\u0432' } } },
  { emoji: '\u{1F680}', category: 'vehicles', names: { en: { singular: 'rocket', count: 'rockets' }, ru: { singular: '\u0440\u0430\u043A\u0435\u0442\u0430', count: '\u0440\u0430\u043A\u0435\u0442' } } },
  { emoji: '\u{1F695}', category: 'vehicles', names: { en: { singular: 'taxi', count: 'taxis' }, ru: { singular: '\u0442\u0430\u043A\u0441\u0438', count: '\u0442\u0430\u043A\u0441\u0438' } } },
  { emoji: '\u{1F699}', category: 'vehicles', names: { en: { singular: 'SUV', count: 'SUVs' }, ru: { singular: '\u0432\u043D\u0435\u0434\u043E\u0440\u043E\u0436\u043D\u0438\u043A', count: '\u0432\u043D\u0435\u0434\u043E\u0440\u043E\u0436\u043D\u0438\u043A\u043E\u0432' } } },
  { emoji: '\u{1F34E}', category: 'food', names: { en: { singular: 'apple', count: 'apples' }, ru: { singular: '\u044F\u0431\u043B\u043E\u043A\u043E', count: '\u044F\u0431\u043B\u043E\u043A' } } },
  { emoji: '\u{1F350}', category: 'food', names: { en: { singular: 'pear', count: 'pears' }, ru: { singular: '\u0433\u0440\u0443\u0448\u0430', count: '\u0433\u0440\u0443\u0448' } } },
  { emoji: '\u{1F34A}', category: 'food', names: { en: { singular: 'orange', count: 'oranges' }, ru: { singular: '\u0430\u043F\u0435\u043B\u044C\u0441\u0438\u043D', count: '\u0430\u043F\u0435\u043B\u044C\u0441\u0438\u043D\u043E\u0432' } } },
  { emoji: '\u{1F34B}', category: 'food', names: { en: { singular: 'lemon', count: 'lemons' }, ru: { singular: '\u043B\u0438\u043C\u043E\u043D', count: '\u043B\u0438\u043C\u043E\u043D\u043E\u0432' } } },
  { emoji: '\u{1F34C}', category: 'food', names: { en: { singular: 'banana', count: 'bananas' }, ru: { singular: '\u0431\u0430\u043D\u0430\u043D', count: '\u0431\u0430\u043D\u0430\u043D\u043E\u0432' } } },
  { emoji: '\u{1F349}', category: 'food', names: { en: { singular: 'watermelon', count: 'watermelons' }, ru: { singular: '\u0430\u0440\u0431\u0443\u0437', count: '\u0430\u0440\u0431\u0443\u0437\u043E\u0432' } } },
  { emoji: '\u{1F347}', category: 'food', names: { en: { singular: 'grape', count: 'grapes' }, ru: { singular: '\u0432\u0438\u043D\u043E\u0433\u0440\u0430\u0434\u0438\u043D\u0430', count: '\u0432\u0438\u043D\u043E\u0433\u0440\u0430\u0434\u0438\u043D' } } },
  { emoji: '\u{1F353}', category: 'food', names: { en: { singular: 'strawberry', count: 'strawberries' }, ru: { singular: '\u043A\u043B\u0443\u0431\u043D\u0438\u043A\u0430', count: '\u043A\u043B\u0443\u0431\u043D\u0438\u043A' } } },
  { emoji: '\u{1F352}', category: 'food', names: { en: { singular: 'cherry', count: 'cherries' }, ru: { singular: '\u0432\u0438\u0448\u043D\u044F', count: '\u0432\u0438\u0448\u0435\u043D' } } },
  { emoji: '\u{1F34D}', category: 'food', names: { en: { singular: 'pineapple', count: 'pineapples' }, ru: { singular: '\u0430\u043D\u0430\u043D\u0430\u0441', count: '\u0430\u043D\u0430\u043D\u0430\u0441\u043E\u0432' } } },
  { emoji: '\u{1F95D}', category: 'food', names: { en: { singular: 'kiwi', count: 'kiwis' }, ru: { singular: '\u043A\u0438\u0432\u0438', count: '\u043A\u0438\u0432\u0438' } } },
  { emoji: '\u{1F955}', category: 'food', names: { en: { singular: 'carrot', count: 'carrots' }, ru: { singular: '\u043C\u043E\u0440\u043A\u043E\u0432\u043A\u0430', count: '\u043C\u043E\u0440\u043A\u043E\u0432\u043E\u043A' } } },
  { emoji: '\u{1F33D}', category: 'food', names: { en: { singular: 'corn cob', count: 'corn cobs' }, ru: { singular: '\u043F\u043E\u0447\u0430\u0442\u043E\u043A \u043A\u0443\u043A\u0443\u0440\u0443\u0437\u044B', count: '\u043F\u043E\u0447\u0430\u0442\u043A\u043E\u0432 \u043A\u0443\u043A\u0443\u0440\u0443\u0437\u044B' } } },
  { emoji: '\u{1F345}', category: 'food', names: { en: { singular: 'tomato', count: 'tomatoes' }, ru: { singular: '\u043F\u043E\u043C\u0438\u0434\u043E\u0440', count: '\u043F\u043E\u043C\u0438\u0434\u043E\u0440\u043E\u0432' } } },
  { emoji: '\u{1F954}', category: 'food', names: { en: { singular: 'potato', count: 'potatoes' }, ru: { singular: '\u043A\u0430\u0440\u0442\u043E\u0444\u0435\u043B\u0438\u043D\u0430', count: '\u043A\u0430\u0440\u0442\u043E\u0444\u0435\u043B\u0438\u043D' } } },
  { emoji: '\u{1F966}', category: 'food', names: { en: { singular: 'broccoli', count: 'broccoli' }, ru: { singular: '\u0431\u0440\u043E\u043A\u043A\u043E\u043B\u0438', count: '\u0431\u0440\u043E\u043A\u043A\u043E\u043B\u0438' } } },
  { emoji: '\u{1F952}', category: 'food', names: { en: { singular: 'cucumber', count: 'cucumbers' }, ru: { singular: '\u043E\u0433\u0443\u0440\u0435\u0446', count: '\u043E\u0433\u0443\u0440\u0446\u043E\u0432' } } },
  { emoji: '\u{1F355}', category: 'food', names: { en: { singular: 'pizza', count: 'pizzas' }, ru: { singular: '\u043F\u0438\u0446\u0446\u0430', count: '\u043F\u0438\u0446\u0446' } } },
  { emoji: '\u{1F354}', category: 'food', names: { en: { singular: 'burger', count: 'burgers' }, ru: { singular: '\u0431\u0443\u0440\u0433\u0435\u0440', count: '\u0431\u0443\u0440\u0433\u0435\u0440\u043E\u0432' } } },
  { emoji: '\u{1F35F}', category: 'food', names: { en: { singular: 'fries', count: 'fries' }, ru: { singular: '\u043A\u0430\u0440\u0442\u043E\u0448\u043A\u0430 \u0444\u0440\u0438', count: '\u043F\u043E\u0440\u0446\u0438\u0439 \u043A\u0430\u0440\u0442\u043E\u0448\u043A\u0438 \u0444\u0440\u0438' } } },
  { emoji: '\u{1F32D}', category: 'food', names: { en: { singular: 'hot dog', count: 'hot dogs' }, ru: { singular: '\u0445\u043E\u0442-\u0434\u043E\u0433', count: '\u0445\u043E\u0442-\u0434\u043E\u0433\u043E\u0432' } } },
  { emoji: '\u{1F32E}', category: 'food', names: { en: { singular: 'taco', count: 'tacos' }, ru: { singular: '\u0442\u0430\u043A\u043E', count: '\u0442\u0430\u043A\u043E' } } },
  { emoji: '\u{1F32F}', category: 'food', names: { en: { singular: 'burrito', count: 'burritos' }, ru: { singular: '\u0431\u0443\u0440\u0440\u0438\u0442\u043E', count: '\u0431\u0443\u0440\u0440\u0438\u0442\u043E' } } },
  { emoji: '\u{1F37F}', category: 'food', names: { en: { singular: 'popcorn', count: 'popcorn buckets' }, ru: { singular: '\u043F\u043E\u043F\u043A\u043E\u0440\u043D', count: '\u0432\u0451\u0434\u0435\u0440 \u043F\u043E\u043F\u043A\u043E\u0440\u043D\u0430' } } },
  { emoji: '\u{1F36A}', category: 'food', names: { en: { singular: 'cookie', count: 'cookies' }, ru: { singular: '\u043F\u0435\u0447\u0435\u043D\u044C\u043A\u0430', count: '\u043F\u0435\u0447\u0435\u043D\u0435\u043A' } } },
  { emoji: '\u{1F369}', category: 'food', names: { en: { singular: 'donut', count: 'donuts' }, ru: { singular: '\u043F\u043E\u043D\u0447\u0438\u043A', count: '\u043F\u043E\u043D\u0447\u0438\u043A\u043E\u0432' } } },
  { emoji: '\u{1F9C1}', category: 'food', names: { en: { singular: 'cupcake', count: 'cupcakes' }, ru: { singular: '\u043A\u0430\u043F\u043A\u0435\u0439\u043A', count: '\u043A\u0430\u043F\u043A\u0435\u0439\u043A\u043E\u0432' } } },
  { emoji: '\u{1F370}', category: 'food', names: { en: { singular: 'cake', count: 'cakes' }, ru: { singular: '\u0442\u043E\u0440\u0442', count: '\u0442\u043E\u0440\u0442\u043E\u0432' } } },
  { emoji: '\u{1F36B}', category: 'food', names: { en: { singular: 'chocolate bar', count: 'chocolate bars' }, ru: { singular: '\u0448\u043E\u043A\u043E\u043B\u0430\u0434\u043A\u0430', count: '\u0448\u043E\u043A\u043E\u043B\u0430\u0434\u043E\u043A' } } },
  { emoji: '\u{1F36D}', category: 'food', names: { en: { singular: 'lollipop', count: 'lollipops' }, ru: { singular: '\u043B\u0435\u0434\u0435\u043D\u0435\u0446', count: '\u043B\u0435\u0434\u0435\u043D\u0446\u043E\u0432' } } },
  { emoji: '\u{1F368}', category: 'food', names: { en: { singular: 'ice cream', count: 'ice creams' }, ru: { singular: '\u043C\u043E\u0440\u043E\u0436\u0435\u043D\u043E\u0435', count: '\u043F\u043E\u0440\u0446\u0438\u0439 \u043C\u043E\u0440\u043E\u0436\u0435\u043D\u043E\u0433\u043E' } } },
  { emoji: '\u{1F338}', category: 'nature', names: { en: { singular: 'flower', count: 'flowers' }, ru: { singular: '\u0446\u0432\u0435\u0442\u043E\u043A', count: '\u0446\u0432\u0435\u0442\u043E\u0432' } } },
  { emoji: '\u{1F340}', category: 'nature', names: { en: { singular: 'clover', count: 'clovers' }, ru: { singular: '\u043A\u043B\u0435\u0432\u0435\u0440', count: '\u043A\u043B\u0435\u0432\u0435\u0440\u043E\u0432' } } },
  { emoji: '\u{1F334}', category: 'nature', names: { en: { singular: 'palm tree', count: 'palm trees' }, ru: { singular: '\u043F\u0430\u043B\u044C\u043C\u0430', count: '\u043F\u0430\u043B\u044C\u043C' } } },
  { emoji: '\u{1F335}', category: 'nature', names: { en: { singular: 'cactus', count: 'cactuses' }, ru: { singular: '\u043A\u0430\u043A\u0442\u0443\u0441', count: '\u043A\u0430\u043A\u0442\u0443\u0441\u043E\u0432' } } },
  { emoji: '\u{1F308}', category: 'nature', names: { en: { singular: 'rainbow', count: 'rainbows' }, ru: { singular: '\u0440\u0430\u0434\u0443\u0433\u0430', count: '\u0440\u0430\u0434\u0443\u0433' } } },
  { emoji: '\u{1F319}', category: 'nature', names: { en: { singular: 'moon', count: 'moons' }, ru: { singular: '\u043B\u0443\u043D\u0430', count: '\u043B\u0443\u043D' } } },
  { emoji: '\u{1F31E}', category: 'nature', names: { en: { singular: 'sun', count: 'suns' }, ru: { singular: '\u0441\u043E\u043B\u043D\u0446\u0435', count: '\u0441\u043E\u043B\u043D\u0446' } } },
  { emoji: '\u{1F30A}', category: 'nature', names: { en: { singular: 'wave', count: 'waves' }, ru: { singular: '\u0432\u043E\u043B\u043D\u0430', count: '\u0432\u043E\u043B\u043D' } } },
  { emoji: '\u{1F3C0}', category: 'sports', names: { en: { singular: 'basketball', count: 'basketballs' }, ru: { singular: '\u0431\u0430\u0441\u043A\u0435\u0442\u0431\u043E\u043B\u044C\u043D\u044B\u0439 \u043C\u044F\u0447', count: '\u0431\u0430\u0441\u043A\u0435\u0442\u0431\u043E\u043B\u044C\u043D\u044B\u0445 \u043C\u044F\u0447\u0435\u0439' } } },
  { emoji: '\u{1F3BE}', category: 'sports', names: { en: { singular: 'tennis ball', count: 'tennis balls' }, ru: { singular: '\u0442\u0435\u043D\u043D\u0438\u0441\u043D\u044B\u0439 \u043C\u044F\u0447', count: '\u0442\u0435\u043D\u043D\u0438\u0441\u043D\u044B\u0445 \u043C\u044F\u0447\u0435\u0439' } } },
  { emoji: '\u{1F3D0}', category: 'sports', names: { en: { singular: 'volleyball', count: 'volleyballs' }, ru: { singular: '\u0432\u043E\u043B\u0435\u0439\u0431\u043E\u043B\u044C\u043D\u044B\u0439 \u043C\u044F\u0447', count: '\u0432\u043E\u043B\u0435\u0439\u0431\u043E\u043B\u044C\u043D\u044B\u0445 \u043C\u044F\u0447\u0435\u0439' } } },
  { emoji: '\u{1F3C2}', category: 'sports', names: { en: { singular: 'snowboarder', count: 'snowboarders' }, ru: { singular: '\u0441\u043D\u043E\u0443\u0431\u043E\u0440\u0434\u0438\u0441\u0442', count: '\u0441\u043D\u043E\u0443\u0431\u043E\u0440\u0434\u0438\u0441\u0442\u043E\u0432' } } },
  { emoji: '\u{1F6F9}', category: 'sports', names: { en: { singular: 'skateboard', count: 'skateboards' }, ru: { singular: '\u0441\u043A\u0435\u0439\u0442\u0431\u043E\u0440\u0434', count: '\u0441\u043A\u0435\u0439\u0442\u0431\u043E\u0440\u0434\u043E\u0432' } } },
  { emoji: '\u{1F3AF}', category: 'sports', names: { en: { singular: 'target', count: 'targets' }, ru: { singular: '\u043C\u0438\u0448\u0435\u043D\u044C', count: '\u043C\u0438\u0448\u0435\u043D\u0435\u0439' } } },
  { emoji: '\u{1F3C6}', category: 'sports', names: { en: { singular: 'trophy', count: 'trophies' }, ru: { singular: '\u043A\u0443\u0431\u043E\u043A', count: '\u043A\u0443\u0431\u043A\u043E\u0432' } } },
  { emoji: '\u{1F381}', category: 'objects', names: { en: { singular: 'gift', count: 'gifts' }, ru: { singular: '\u043F\u043E\u0434\u0430\u0440\u043E\u043A', count: '\u043F\u043E\u0434\u0430\u0440\u043A\u043E\u0432' } } },
  { emoji: '\u{1F388}', category: 'objects', names: { en: { singular: 'balloon', count: 'balloons' }, ru: { singular: '\u0448\u0430\u0440\u0438\u043A', count: '\u0448\u0430\u0440\u0438\u043A\u043E\u0432' } } },
  { emoji: '\u{1F9F8}', category: 'objects', names: { en: { singular: 'teddy bear', count: 'teddy bears' }, ru: { singular: '\u043F\u043B\u044E\u0448\u0435\u0432\u044B\u0439 \u043C\u0438\u0448\u043A\u0430', count: '\u043F\u043B\u044E\u0448\u0435\u0432\u044B\u0445 \u043C\u0438\u0448\u0435\u043A' } } },
  { emoji: '\u{1F4D8}', category: 'objects', names: { en: { singular: 'book', count: 'books' }, ru: { singular: '\u043A\u043D\u0438\u0433\u0430', count: '\u043A\u043D\u0438\u0433' } } },
  { emoji: '\u{1F4CF}', category: 'objects', names: { en: { singular: 'ruler', count: 'rulers' }, ru: { singular: '\u043B\u0438\u043D\u0435\u0439\u043A\u0430', count: '\u043B\u0438\u043D\u0435\u0435\u043A' } } },
  { emoji: '\u{1F4CE}', category: 'objects', names: { en: { singular: 'paperclip', count: 'paperclips' }, ru: { singular: '\u0441\u043A\u0440\u0435\u043F\u043A\u0430', count: '\u0441\u043A\u0440\u0435\u043F\u043E\u043A' } } },
  { emoji: '\u{1F50D}', category: 'objects', names: { en: { singular: 'magnifying glass', count: 'magnifying glasses' }, ru: { singular: '\u043B\u0443\u043F\u0430', count: '\u043B\u0443\u043F' } } },
  { emoji: '\u{1F512}', category: 'objects', names: { en: { singular: 'lock', count: 'locks' }, ru: { singular: '\u0437\u0430\u043C\u043E\u043A', count: '\u0437\u0430\u043C\u043A\u043E\u0432' } } },
  { emoji: '\u23F0', category: 'objects', names: { en: { singular: 'alarm clock', count: 'alarm clocks' }, ru: { singular: '\u0431\u0443\u0434\u0438\u043B\u044C\u043D\u0438\u043A', count: '\u0431\u0443\u0434\u0438\u043B\u044C\u043D\u0438\u043A\u043E\u0432' } } },
  { emoji: '\u{1F9ED}', category: 'objects', names: { en: { singular: 'compass', count: 'compasses' }, ru: { singular: '\u043A\u043E\u043C\u043F\u0430\u0441', count: '\u043A\u043E\u043C\u043F\u0430\u0441\u043E\u0432' } } },
  { emoji: '\u{1F511}', category: 'objects', names: { en: { singular: 'key', count: 'keys' }, ru: { singular: '\u043A\u043B\u044E\u0447', count: '\u043A\u043B\u044E\u0447\u0435\u0439' } } },
  { emoji: '\u{1F4DD}', category: 'objects', names: { en: { singular: 'memo', count: 'memos' }, ru: { singular: '\u0437\u0430\u043F\u0438\u0441\u043A\u0430', count: '\u0437\u0430\u043F\u0438\u0441\u043E\u043A' } } },
];

const EMOJI_CATEGORY_NAMES = ['animals', 'vehicles', 'food', 'nature', 'sports', 'objects'];
const EMOJI_CATEGORIES = {};
for (const cat of EMOJI_CATEGORY_NAMES) {
  EMOJI_CATEGORIES[cat] = EMOJI_LEXICON.filter(e => e.category === cat);
}
const getEmojiEntry = (emoji) => EMOJI_LEXICON.find(e => e.emoji === emoji);
const getEmojiName = (emoji, lang = 'en', form = 'singular') => {
  const entry = getEmojiEntry(emoji);
  if (!entry) return emoji;
  const localized = entry.names[lang] || entry.names.en;
  return localized[form] || entry.names.en[form];
};
const getFilteredLexicon = (category) => {
  if (!category || category === 'all') return EMOJI_LEXICON.slice();
  return (EMOJI_CATEGORIES[category] || []).slice();
};

const NOISE_SYMBOL_SETS = {
  shapes: ['\u2605', '\u2666', '\u25CF', '\u25B2', '\u25A0', '\u25C6', '\u25BC', '\u25C9'],
  cards:  ['\u2660', '\u2663', '\u2665', '\u2666', '\u2664', '\u2667', '\u2661', '\u2662'],
  arrows: ['\u2192', '\u2190', '\u2191', '\u2193', '\u21D2', '\u21D0', '\u21D1', '\u21D3']
};

const CIRCLED_DIGITS = ['\u24EA', '\u2460', '\u2461', '\u2462', '\u2463', '\u2464', '\u2465', '\u2466', '\u2467', '\u2468'];

function toCircledDigits(numStr) {
  return [...numStr].map(ch => {
    const d = parseInt(ch, 10);
    return (d >= 0 && d <= 9) ? CIRCLED_DIGITS[d] : ch;
  }).join('');
}
</script>

<script>

const $ = id => document.getElementById(id);
const ctx = $('can').getContext('2d');
const NAME = 'emoji_code_scatter';

const DEF = {
  w: 400, h: 600, code: '1234',
  rowCount: 6, rowHeight: 12,
  layoutMode: 'rows',
  columns: 'auto', gridCols: 3,
  showEmoji: false,
  markerShape: 'circle', dotStyle: 'filled',
  leaderStyle: 'dots', numberFormat: 'plain',
  noiseSymbolStyle: 'none',
  category: 'all', lang: 'en'
};

const DOT_COLORS = [
  '#C41E3A', '#0066CC', '#228B22', '#CC6600',
  '#6B3FA0', '#008B8B', '#B8860B', '#CC3366',
];

let rows = [];
let answerEntry = null;

const shuffle = arr => {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
};

function generateRandomCode(length) {
  let code = '';
  for (let i = 0; i < length; i++) code += Math.floor(Math.random() * 10);
  return code;
}

// Helper: draw marker shape at (cx, cy) with given radius and color
function drawMarker(cx, cy, radius, color, style) {
  const shape = $('markerShape').value;
  ctx.fillStyle = color;
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;

  switch (shape) {
    case 'circle':
      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, Math.PI * 2);
      if (style === 'filled') ctx.fill(); else ctx.stroke();
      break;

    case 'square':
      if (style === 'filled') {
        ctx.fillRect(cx - radius, cy - radius, radius * 2, radius * 2);
      } else {
        ctx.strokeRect(cx - radius, cy - radius, radius * 2, radius * 2);
      }
      break;

    case 'triangle':
      ctx.beginPath();
      ctx.moveTo(cx, cy - radius);
      ctx.lineTo(cx + radius, cy + radius);
      ctx.lineTo(cx - radius, cy + radius);
      ctx.closePath();
      if (style === 'filled') ctx.fill(); else ctx.stroke();
      break;

    case 'star': {
      const spikes = 5;
      const outerR = radius;
      const innerR = radius * 0.45;
      ctx.beginPath();
      for (let i = 0; i < spikes * 2; i++) {
        const r = i % 2 === 0 ? outerR : innerR;
        const angle = (Math.PI / 2 * -1) + (Math.PI / spikes) * i;
        const sx = cx + Math.cos(angle) * r;
        const sy = cy + Math.sin(angle) * r;
        if (i === 0) ctx.moveTo(sx, sy); else ctx.lineTo(sx, sy);
      }
      ctx.closePath();
      if (style === 'filled') ctx.fill(); else ctx.stroke();
      break;
    }

    case 'diamond':
      ctx.beginPath();
      ctx.moveTo(cx, cy - radius);
      ctx.lineTo(cx + radius, cy);
      ctx.lineTo(cx, cy + radius);
      ctx.lineTo(cx - radius, cy);
      ctx.closePath();
      if (style === 'filled') ctx.fill(); else ctx.stroke();
      break;

    case 'heart': {
      const s = radius * 0.85;
      ctx.beginPath();
      ctx.moveTo(cx, cy + s * 0.8);
      ctx.bezierCurveTo(cx - s * 1.3, cy - s * 0.2, cx - s * 0.6, cy - s * 1.2, cx, cy - s * 0.4);
      ctx.bezierCurveTo(cx + s * 0.6, cy - s * 1.2, cx + s * 1.3, cy - s * 0.2, cx, cy + s * 0.8);
      ctx.closePath();
      if (style === 'filled') ctx.fill(); else ctx.stroke();
      break;
    }
  }
}

// Helper: draw leader line between word and number
function drawLeader(leaderStart, leaderEnd, centerY, fontSize) {
  const leaderStyle = $('leaderStyle').value;
  if (leaderEnd <= leaderStart + 8 || leaderStyle === 'none') return;

  if (leaderStyle === 'dots') {
    ctx.font = `${fontSize * 0.8}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#CCC';
    ctx.textAlign = 'left';
    const dotW = ctx.measureText('.').width;
    const spacing = dotW * 1.2;
    let dx = leaderStart;
    while (dx + dotW < leaderEnd) {
      ctx.fillText('.', dx, centerY);
      dx += spacing;
    }
  } else if (leaderStyle === 'dashes') {
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(leaderStart, centerY);
    ctx.lineTo(leaderEnd, centerY);
    ctx.strokeStyle = '#CCC';
    ctx.lineWidth = 1;
    ctx.setLineDash([5, 3]);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
  } else if (leaderStyle === 'solid') {
    ctx.beginPath();
    ctx.moveTo(leaderStart, centerY);
    ctx.lineTo(leaderEnd, centerY);
    ctx.strokeStyle = '#CCC';
    ctx.lineWidth = 1;
    ctx.stroke();
  } else if (leaderStyle === 'arrows') {
    ctx.font = `${fontSize * 0.7}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#CCC';
    ctx.textAlign = 'left';
    const arrowW = ctx.measureText('>').width;
    const spacing = arrowW * 1.5;
    let dx = leaderStart;
    while (dx + arrowW < leaderEnd) {
      ctx.fillText('>', dx, centerY);
      dx += spacing;
    }
  }
}

// Helper: format and draw number with the selected numberFormat
function drawNumber(numStr, numberX, centerY, fontSize) {
  const numberFormat = $('numberFormat').value;
  ctx.textAlign = 'right';

  let displayNumber = numStr;
  if (numberFormat === 'circled') {
    displayNumber = toCircledDigits(numStr);
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#111';
    ctx.fillText(displayNumber, numberX, centerY);
  } else if (numberFormat === 'bold-block') {
    ctx.font = `900 ${fontSize * 1.3}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#111';
    ctx.fillText(displayNumber, numberX, centerY);
  } else if (numberFormat === 'boxed') {
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, sans-serif`;
    const numW = ctx.measureText(displayNumber).width;
    const boxPadX = fontSize * 0.25;
    const boxPadY = fontSize * 0.18;
    const boxX = numberX - numW - boxPadX;
    const boxY = centerY - fontSize * 0.5 - boxPadY;
    const boxW = numW + boxPadX * 2;
    const boxH = fontSize + boxPadY * 2;
    const boxR = 4;
    ctx.fillStyle = '#EEE';
    ctx.beginPath();
    ctx.moveTo(boxX + boxR, boxY);
    ctx.lineTo(boxX + boxW - boxR, boxY);
    ctx.quadraticCurveTo(boxX + boxW, boxY, boxX + boxW, boxY + boxR);
    ctx.lineTo(boxX + boxW, boxY + boxH - boxR);
    ctx.quadraticCurveTo(boxX + boxW, boxY + boxH, boxX + boxW - boxR, boxY + boxH);
    ctx.lineTo(boxX + boxR, boxY + boxH);
    ctx.quadraticCurveTo(boxX, boxY + boxH, boxX, boxY + boxH - boxR);
    ctx.lineTo(boxX, boxY + boxR);
    ctx.quadraticCurveTo(boxX, boxY, boxX + boxR, boxY);
    ctx.closePath();
    ctx.fill();
    ctx.strokeStyle = '#999';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.fillStyle = '#111';
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, sans-serif`;
    ctx.textAlign = 'right';
    ctx.fillText(displayNumber, numberX, centerY);
  } else {
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#111';
    ctx.fillText(displayNumber, numberX, centerY);
  }

  // Return measured width for leader calculation
  let numWidth;
  if (numberFormat === 'bold-block') {
    ctx.font = `900 ${fontSize * 1.3}px system-ui, -apple-system, sans-serif`;
    numWidth = ctx.measureText(displayNumber).width;
  } else if (numberFormat === 'boxed') {
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, sans-serif`;
    numWidth = ctx.measureText(displayNumber).width + fontSize * 0.5;
  } else {
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, sans-serif`;
    numWidth = ctx.measureText(displayNumber).width;
  }
  return numWidth;
}

function generateRows() {
  const codeStr = $('code').value || '1234';
  const numRows = +$('rowCount').value;
  const cat = $('category').value;
  const lang = $('lang').value;
  const noiseStyle = $('noiseSymbolStyle').value;

  // Noise: when enabled, noise count = 50% of real rows (rounded)
  const noiseCount = noiseStyle === 'none' ? 0 : Math.round(numRows * 0.5);

  const pool = getFilteredLexicon(cat);
  if (pool.length < numRows) {
    pool.length = 0;
    pool.push(...EMOJI_LEXICON.slice());
  }
  shuffle(pool);
  const chosen = pool.slice(0, numRows);

  const answerIdx = Math.floor(Math.random() * chosen.length);
  answerEntry = chosen[answerIdx];

  const totalDistractors = numRows - 1 + noiseCount;
  const usedNumbers = new Set([codeStr]);
  const distractorNumbers = [];
  let attempts = 0;
  while (distractorNumbers.length < totalDistractors && attempts < 10000) {
    const num = generateRandomCode(codeStr.length);
    if (!usedNumbers.has(num)) {
      usedNumbers.add(num);
      distractorNumbers.push(num);
    }
    attempts++;
  }

  rows = [];
  let dIdx = 0;
  for (let i = 0; i < chosen.length; i++) {
    const word = getEmojiName(chosen[i].emoji, lang, 'singular');
    const dotColor = DOT_COLORS[Math.floor(Math.random() * DOT_COLORS.length)];
    rows.push({
      number: i === answerIdx ? codeStr : (distractorNumbers[dIdx++] || '0000'),
      emoji: chosen[i].emoji,
      word: word,
      dotColor: dotColor,
      isAnswer: i === answerIdx,
      isNoise: false
    });
  }

  // Add noise rows
  if (noiseCount > 0) {
    const symbols = NOISE_SYMBOL_SETS[noiseStyle] || NOISE_SYMBOL_SETS.shapes;
    const symbolPool = symbols.slice();
    shuffle(symbolPool);
    for (let n = 0; n < noiseCount; n++) {
      const sym = symbolPool[n % symbolPool.length];
      const dotColor = DOT_COLORS[Math.floor(Math.random() * DOT_COLORS.length)];
      rows.push({
        number: distractorNumbers[dIdx++] || generateRandomCode(codeStr.length),
        emoji: sym,
        word: sym,
        dotColor: dotColor,
        isAnswer: false,
        isNoise: true
      });
    }
  }

  shuffle(rows);
}

function draw() {
  const W = +$('w').value, H = +$('h').value;
  $('can').width = W;
  $('can').height = H;

  ctx.fillStyle = '#fff';
  ctx.fillRect(0, 0, W, H);

  if (rows.length === 0) generateRows();

  const layoutMode = $('layoutMode').value;
  if (layoutMode === 'grid') {
    drawGrid(W, H);
  } else {
    drawRowsLayout(W, H);
  }
}

function drawGrid(W, H) {
  const numGridCols = +$('gridCols').value;
  const showEmoji = $('showEmoji').checked;
  const dotStyle = $('dotStyle').value;

  const mainH = H * 0.85;
  const bottomY = mainH;
  const padding = W * 0.03;
  const availW = W - padding * 2;
  const cellW = availW / numGridCols;

  const totalCells = rows.length;
  const totalGridRows = Math.ceil(totalCells / numGridCols);
  const cellH = Math.min((mainH - padding * 2) / totalGridRows, mainH * 0.12);
  const fontSize = Math.min(cellH * 0.28, H * 0.03);

  let curY = padding;
  let curCol = 0;
  const lineH = cellH / (showEmoji ? 3.5 : 2.5);

  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];
    const x0 = padding + curCol * cellW;
    const y0 = curY;

    if (y0 + cellH > mainH) break;

    // Cell background (alternating)
    const bgColor = (curCol + Math.floor((curY - padding) / cellH)) % 2 === 0 ? '#FFFFFF' : '#F8F8F8';
    ctx.fillStyle = bgColor;
    ctx.fillRect(x0, y0, cellW, cellH);

    // Cell border
    ctx.strokeStyle = '#DDD';
    ctx.lineWidth = 1;
    ctx.strokeRect(x0, y0, cellW, cellH);

    let textY = y0 + cellH * 0.15;

    if (showEmoji) {
      ctx.font = `${fontSize * 1.3}px system-ui, -apple-system, sans-serif`;
      ctx.fillStyle = '#333';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(r.emoji, x0 + cellW / 2, textY);
      textY += lineH;
    }

    // Word
    ctx.font = `${fontSize}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#333';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillText(r.word, x0 + cellW / 2, textY);
    textY += lineH;

    // Number
    ctx.font = `bold ${fontSize}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#111';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillText(r.number, x0 + cellW / 2, textY);

    curCol++;
    if (curCol >= numGridCols) {
      curCol = 0;
      curY += cellH;
    }
  }

  drawBottomSection(W, H, bottomY);
}

function drawRowsLayout(W, H) {
  const numRows = rows.length;
  const colSetting = $('columns').value;
  const numCols = colSetting === 'auto' ? (numRows > 10 ? 2 : 1) : +colSetting;
  const dotStyle = $('dotStyle').value;
  const rowHeightPct = +$('rowHeight').value / 100;

  const mainH = H * 0.85;
  const bottomY = mainH;
  const padding = W * 0.03;
  const colW = (W - padding * 2) / numCols;
  const colGap = padding * 0.5;

  const rowsPerCol = Math.ceil(numRows / numCols);
  const maxRowH = (mainH - padding * 2) / rowsPerCol;
  const rowH = Math.min(H * rowHeightPct, maxRowH);
  const fontSize = Math.min(rowH * 0.55, H * 0.04);
  const dotRadius = fontSize * 0.22;

  for (let i = 0; i < numRows; i++) {
    const col = Math.floor(i / rowsPerCol);
    const rowInCol = i % rowsPerCol;
    const r = rows[i];

    const x0 = padding + col * colW;
    const y = padding + rowInCol * rowH;

    if (y + rowH > mainH) continue;

    // Alternating row background
    const bgColor = rowInCol % 2 === 0 ? '#FFFFFF' : '#F5F5F5';
    ctx.fillStyle = bgColor;
    ctx.fillRect(x0, y, colW - colGap, rowH);

    const centerY = y + rowH / 2;
    const dotX = x0 + dotRadius + 8;

    // Draw marker
    if (dotStyle !== 'none') {
      drawMarker(dotX, centerY, dotRadius, r.dotColor, dotStyle);
    }

    // Emoji + Word
    const showEmoji = $('showEmoji').checked;
    const labelX = dotStyle === 'none' ? (x0 + 8) : (dotX + dotRadius + 8);
    ctx.font = `${fontSize}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#333';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    let wordX = labelX;
    if (showEmoji) {
      ctx.fillText(r.emoji, labelX, centerY);
      wordX = labelX + ctx.measureText(r.emoji).width + 4;
    }
    ctx.fillText(r.word, wordX, centerY);
    const wordWidth = ctx.measureText(r.word).width;

    // Number (right-aligned)
    const numberX = x0 + colW - colGap - 8;
    const numWidth = drawNumber(r.number, numberX, centerY, fontSize);

    // Leader line between word and number
    const leaderStart = wordX + wordWidth + 6;
    const leaderEnd = numberX - numWidth - 4;
    drawLeader(leaderStart, leaderEnd, centerY, fontSize);
  }

  // Separator line
  ctx.beginPath();
  ctx.moveTo(W * 0.05, bottomY);
  ctx.lineTo(W * 0.95, bottomY);
  ctx.strokeStyle = '#bbb';
  ctx.lineWidth = 2;
  ctx.setLineDash([]);
  ctx.stroke();

  drawBottomSection(W, H, bottomY);
}

function drawBottomSection(W, H, bottomY) {
  // Separator line (for grid mode)
  if ($('layoutMode').value === 'grid') {
    ctx.beginPath();
    ctx.moveTo(W * 0.05, bottomY);
    ctx.lineTo(W * 0.95, bottomY);
    ctx.strokeStyle = '#bbb';
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  // Bottom zone: emoji prompt
  const bottomCenterY = bottomY + (H - bottomY) / 2;
  const promptFontSize = (H - bottomY) * 0.45;
  const codeStr = $('code').value || '1234';
  const questionMarks = '?'.repeat(codeStr.length);

  if (answerEntry) {
    const emojiText = answerEntry.emoji;
    const arrowText = ' \u2192 ';
    const qText = questionMarks;

    ctx.font = `${promptFontSize}px system-ui, -apple-system, sans-serif`;
    const emojiW = ctx.measureText(emojiText).width;
    const arrowW = ctx.measureText(arrowText).width;
    const qW = ctx.measureText(qText).width;
    const totalW = emojiW + arrowW + qW;
    const startX = (W - totalW) / 2;

    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillStyle = '#111';
    ctx.fillText(emojiText, startX, bottomCenterY);

    ctx.fillStyle = '#999';
    ctx.fillText(arrowText, startX + emojiW, bottomCenterY);

    ctx.font = `bold ${promptFontSize}px system-ui, -apple-system, sans-serif`;
    ctx.fillStyle = '#999';
    ctx.fillText(qText, startX + emojiW + arrowW, bottomCenterY);
  }
}

// === Event handlers ===

function randCode() {
  const numDigits = ($('code').value || '').length || 4;
  $('code').value = generateRandomCode(numDigits);
}

function fullRedraw() {
  generateRows();
  draw();
}

// Dice button
document.querySelectorAll('[data-t]').forEach(b => {
  b.onclick = () => {
    if (b.dataset.t === 'code') { randCode(); fullRedraw(); }
  };
});

// Inputs that need full regeneration
$('code').oninput = fullRedraw;
$('rowCount').oninput = fullRedraw;
$('category').onchange = fullRedraw;
$('lang').onchange = fullRedraw;
$('noiseSymbolStyle').onchange = fullRedraw;

// Inputs that only need re-draw
$('rowHeight').oninput = draw;
$('layoutMode').onchange = draw;
$('columns').onchange = draw;
$('gridCols').oninput = draw;
$('dotStyle').onchange = draw;
$('markerShape').onchange = draw;
$('leaderStyle').onchange = draw;
$('numberFormat').onchange = draw;
$('showEmoji').onchange = draw;
$('w').oninput = draw;
$('h').oninput = draw;

// Re-render button
$('rerender').onclick = fullRedraw;

// Restore defaults
$('reset').onclick = () => {
  for (const k in DEF) {
    const el = $(k);
    if (!el) continue;
    if (el.type === 'checkbox') {
      el.checked = DEF[k];
    } else {
      el.value = DEF[k];
    }
    if (el.type === 'range') {
      const span = el.nextElementSibling;
      if (span && span.tagName === 'SPAN') span.textContent = DEF[k];
    }
  }
  fullRedraw();
};

// Download on canvas click
$('can').onclick = () => {
  const c = $('code').value || '0000';
  const a = document.createElement('a');
  a.download = `${NAME}_${c}.png`;
  a.href = $('can').toDataURL();
  a.click();
  randCode();
  fullRedraw();
};

// Initial draw
fullRedraw();

</script>
